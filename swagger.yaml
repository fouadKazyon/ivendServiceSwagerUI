openapi: 3.0.3
info:
  title: Kazyon Services for iVend
  description: |-
    This project is consist of 2 API's, and they will be used by iVend to integrate with Kazyon (Coupon and Voucher) Services, one of them is concerned to get all the needed information about the available service and the other one is concernded to validate how on validating the user eligibility for a specific Coupon or Voucher. 
    <br> <h2> The first API (Get Service) </h2> will be called on each start up for any POS machine or every 24 hours to enable bandwith and caching capabilities. This will save a lot of calls and bandwith consumtion.
    <br> <h2> The second API (Post eligibility) </h2> will be called to validate the user eligibility for a coupon or a voucher, and it will get the rquired coupon or voucher information, ex: percentage of discount, maximum discount amount, and minimum receipt value ... etc.  
    <br> <h2> User Defined Table(UDT) </h2> stored in IVend database and contains all data needed about the transactions on which a discound has been applied. the contient of the table is receiptNumber(generated by IVend during the transaction process), transactionId(generated by IVend during the transaction process), eligibilityTransactionId(provided by kazyon in the check eligibility response), serviceId(provided by kazyon in get all services response), appliedDiscountAmmount(calculated by IVend during rhe transaction process)
  

  contact:
    email: mohamed.nasr@kazyon.com
  version: 1.0.01
servers:
  - url: will be available soon...
tags:
  - name: service
    description: Everything about getting available services, validating user eligibility, discount conditions, vouchers details and so on.



paths:
  /service:
    get:
      tags:
        - service
      summary: get all the offered services and all required input parameter to be sent to validation service
      description: This service will be called once daily by iVend to cache all the required information
      operationId: getServicesInfo
      parameters:
        - $ref: '#/components/parameters/storeCode'
        - $ref: '#/components/parameters/storePassword'

      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/servicesInfo'
                example:
                  - serviceProvider: orange
                    coupons:
                      - serviceId: orangeCoupon200
                        displayName: Orange coupon 200
                        icon: <icon_path>
                        attributes:
                          - name: mobileNumber
                            type: string
                            minLength: 11
                            maxLength: 11
                            shownInUI: true
                            regexValidation: '^01\d{9}$'
                            displayName: رقم المحمول

                          - name: code
                            type: string
                            minLength: 4
                            maxLength: 20
                            shownInUI: true
                            displayName: الكود


                          - name: otp
                            type: number
                            minLength: 6
                            maxLength: 8
                            shownInUI: true
                            displayName: رمز التحقق
                      - serviceId: orangeCoupon5P
                        displayName: Orange coupon 5%
                        icon: <icon_path>
                        attributes:
                          - name: mobileNumber
                            type: string
                            minLength: 11
                            maxLength: 11
                            shownInUI: true
                            regexValidation: '^01\d{9}$'
                            displayName: رقم المحمول

                          - name: code
                            type: string
                            minLength: 4
                            maxLength: 20
                            shownInUI: true
                            displayName: الكود

                    vouchers:
                      - serviceId: orangeVoucher100
                        displayName: Orange voucher 100
                        icon: <icon_path>
                        attributes:
                          - name: mobileNumber
                            type: string
                            minLength: 11
                            maxLength: 11
                            shownInUI: true
                            regexValidation: '^01\d{9}$'
                            displayName: رقم المحمول

                          - name: code
                            type: string
                            minLength: 4
                            maxLength: 20
                            shownInUI: true
                            displayName: الكود


                          - name: otp
                            type: number
                            minLength: 6
                            maxLength: 8
                            shownInUI: true
                            displayName: رمز التحقق

                  - serviceProvider: vodafone
                    coupons:
                      - serviceId: vodafoneCoupon50
                        displayName: Vodafone coupon 50
                        icon: <icon_path>
                        attributes:
                          - name: mobileNumber
                            type: string
                            minLength: 11
                            maxLength: 11
                            shownInUI: true
                            regexValidation: '^01\d{9}$'
                            displayName: رقم المحمول

                          - name: code
                            type: string
                            minLength: 4
                            maxLength: 20
                            shownInUI: true
                            displayName: الكود

                          - name: otp
                            type: number
                            minLength: 6
                            maxLength: 8
                            shownInUI: true
                            displayName: رمز التحقق

                    vouchers:
                      -

        '401':
          $ref: '#/components/responses/UnauthorizedError'


  /service/eligibilty:
    post:
      tags:
        - service
      summary: check wether the user is eligible to use an offer or validate a coupon code (for kazyon services only that already exist)
      description: This service will be called with every transaction including one or more vouchers or coupons to validate the user's eligabilty to reedem these codes, the api takes an array of objects each object contains all the required data about one voucher or coupon in the example we show a request containing one coupon, in case of multible coupons or vouchers the array will contain multible object each containing the required attributes for this coupon or voucher so the objects don't have to be similar. The response will be an array containing same number of objects as the request. the objects in the response will all have the same attributes as shown in example but different values.
      operationId: checkUserEligibility
      parameters:
        - $ref: '#/components/parameters/storeCode'
        - $ref: '#/components/parameters/storePassword'

      requestBody:
        description: Send all required parameters as input body that you are already aware of from the [GET] service
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/eligibilityRequest'


      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/eligibiltyResponse'

        '401':
          $ref: '#/components/responses/UnauthorizedError'
          
  /service/eligibilty-sku:
    post:
      tags:
        - service
      summary: check wether the user is eligible to use an offer or validate a coupon code with list of SKUs
      description:  this serveice will be the same like /service/eligibilty but eligibilty-sku will require an extra attribute, hat will be list of SKUs that exist in receipt. it will be mandatory list for any service Id or name.
      operationId: checkUserEligibilityWithSKUs
      parameters:
        - $ref: '#/components/parameters/storeCode'
        - $ref: '#/components/parameters/storePassword'

      requestBody:
        description: Send all required parameters as input body that you are already aware of from the [GET] service
        content:
          application/json:
            schema: 
              $ref: '#/components/schemas/eligibilityRequestSku'
            example: 
              mobileNumber: "01234567891"
              items:
                - sku: "1200005621653"
                  quantity: "2"
                - sku: "56400000212"
                  quantity: "3"
                - sku: "113000684654"
                  quantity: "2"
                


      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema: 
                  $ref: '#/components/schemas/eligibiltyResponseSku'
              example:   
                  - serviceId: "570"
                    sku: "1200005621653"
                    maxQuantity: "2"
                    status : "ELIGIBLE"
                    statusMessage : "الرقم مسموح له ااستخدام"
                    statusMessageDetails : "user eligible"
                    eligibilityTransactionId : "554541"
                    
                  - serviceId: "650"
                    sku: "1200005621654"
                    maxQuantity: "0"
                    status : "NOT_ELIGIBLE"
                    statusMessage : "الرقم غير مسموح له الاستخدام"
                    statusMessageDetails : "user not eligible"
                    eligibilityTransactionId : "5552105"
                    
                  - serviceId: "640"
                    sku: "1200005621653"
                    maxQuantity: "0"
                    status : "OUT_OF_STOCK"
                    statusMessage : "تم نفاذ الكميه لهذا المنتج "
                    statusMessageDetails : "out of stock"
                    eligibilityTransactionId : "5242104"
                
                  
                  

        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /service/confirm:
    post:
      tags:
        - service
      summary: this api will be called once the payment completed it will be for all skus  
      description: api require eligibilityTransactionId and this will be returned from /service/eligibilty-sku endpoint, and also require all skus of the invoice even the skus not included in the discount. 
      operationId: confirmOnComplete
      parameters:
        - $ref: '#/components/parameters/storeCode'
        - $ref: '#/components/parameters/storePassword'

      requestBody:
        description: Send all required parameters as input body that you are already aware of from the [GET] service
        content:
          application/json:
            schema: 
              $ref: '#/components/schemas/confirmRequest'
            
          


      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
               
                  $ref: '#/components/schemas/confirmResponse'
              example:   
                - status: "CONFIRMED"
                  message: "Transactions confirmed"
                  eligibilityTransactionId: "22135"
                  serviceId: "4564"
                  
                - status: "ALREADY_CONFIRMED"
                  message: " transactions Already confirmed"
                  eligibilityTransactionId: "2835"
                  serviceId: "4224"

        '401':
          $ref: '#/components/responses/UnauthorizedError'




components:
  parameters:
    storeCode:
      name: storeCode
      in: header
      description: storeCode
      required: true
      schema:
        type: string
    storePassword:
      name: storePassword
      in: header
      description: store password, will be provided for each store
      required: true
      schema:
        type: string
  responses:
    UnauthorizedError:
      description: Authentication information is missing or invalid

  schemas:
    confirmRequest:
      type: object
      properties:
        
        
        mobileNumber:
          type: string
          example: "01234567899"
        ivendTransactionKey:
          type: string
          example: "322000000000980103"
        appliedDiscountAmount:
          type: number
          example: 300
        ivendTransactionId:
          type: string
          example: "SA2038000037450"
        
        transactionTotalAmount:
          type: number
          example: 1000
          
        confirmList:
            type: array
            items:
              type: object
              properties:
                serviceId: 
                  type: string
                  example: "280"
                  description: string value will be returned from the first api
                
                appliedDiscountAmountPerItem:
                  type: string
                  example: "20"
                eligibilityTransactionId:
                  type: string
                  example: "200125"
                transactionType:
                  type: string
                  example: "TRANSACTED | VOIDED | REFUNDED"
                  description: this enumn will be (TRANSACTED -> this will be to confirm  on SKU that are exist in this  eligibilityTransactionId is completed ), ( [ REFUNDED, VOIDED ] ->  this will be to confirm  on SKU that are exist in this  eligibilityTransactionId is refunded or invoice did not completed )
            example : 
            
              - serviceId: "570"
                appliedDiscountAmountPerItem: "100"
                eligibilityTransactionId : "5649"
                transactionType : "TRANSACTED"
              - serviceId: "650"
                appliedDiscountAmountPerItem: "100"
                eligibilityTransactionId : "5648"
                transactionType : "TRANSACTED"
              - serviceId: "640"
                appliedDiscountAmountPerItem: "100"
                eligibilityTransactionId : "5647"
                transactionType : "TRANSACTED"  
              
        skus:
          type: array
          description: array of all skus of final invoice (skus eligible for discount and normal sku).
          items:
            type: string
          example:
              - "564654000112"
              - "564654000113"
              - "564654000114"
              - "564654000115"
              - "564654000116"
    confirmResponse:
     
      items : 
         type: array
      properties:
        
        status:
          type: string
          description: this will be status for confirmation,(CONFIRMED -> thats indicator the transaction confirmed), (ALREADY_CONFIRMED -> this treansaction id already confirmed), (NOT_EXIST -> this transaction id not found) 
          example: "CONFIRMED | ALREADY_CONFIRMED | NOT_EXIST"
        serviceId:
          type: string
        eligibilityTransactionId:
          type: string
        message:
          type: string
          example: "Transactions confirmed | transactions Already confirmed | transactions not found"
    
    eligibilityRequestSku:
      type: object
      properties:
        mobileNumber:
          type: string
          example: "01234567899"
        items:
          type: array
          items:
            type: object
            properties:
              sku:
                type: string
                description: SKU for product, this will be a string    
              quantity:
                type: integer
                description: Quantity for item, this will be an integer  
      

   
    eligibiltyResponseSku:
      type: object
      properties:
        serviceId:
          type: string
          description: contains the unique identifier for the chosen service
          example: 280
        sku:
          type: string 
          example: "4500001235145"
        maxQuantity: 
          type: number
          example: 2
          description: this will be max quantity that are allowed for this check
        status:
          type: string
          enum:
            - Eligible
            - AlreadyUsed
            - NotEligible
          example: "NOT_ELIGIBLE  || ALREADY_USED ||  ELIGIBLE || NOT_VALID || OUT_OF_STOCK "
          description: it's a enum to have status of check eligiblity  it can be (ELIGIBLE ->  user eligible to get discount), (ALREADY_USED ->  user Already used offer.) or (NOT_ELIGIBLE -> user not eligible for this offer ), (NOT_VALID -> some inputs failed in validation and reason of validation will be in statusMessageDetails), (OUT_OF_STOCK -> stock is not enough for this sku) 
        statusMessage:
          type: string
          example: "رقم الهاتف غير مسموح له الاستخدام | رقم الهاتف مستخدم من قبل| تم نفاذ الكميه لهذا المنتج"
          description: it is description for user to be shown in screen if needed
        statusMessageDetails:
          type: string
          example: "out of stock.  || Mobile number already used || رقم الهاتف غير مسموح له الاستخدام"
          description: it is description for developer descripe the status of Eligibility
        eligibilityTransactionId:
          type: string
          example: 4521001
          description: unique identifier for each transaction, should be stored in User-Defined Table (UDT).

           
           
    eligibilityRequest:
      type: object
      properties:
        serviceId:
          type: string
          description: contains the unique identifier for the chosen service
          example: vodafoneCoupon50
        mobileNumber:
          type: string
          example: "01234567899"
        code:
          type: string
          example: "KZ123"
        otp:
          type: string
          example: "123456"
        sku:
          type: array
          items: 
            type: string
          example:
              - "12540005511489"
              - "12540005511490"
              - "12540005511491"
          

  
    
    eligibiltyResponse:
      type: object
      properties:
        serviceId:
          type: string
          description: contains the unique identifier for the chosen service
          example: vodafoneCoupon50
        status:
          type: string
          enum:
            - Eligible
            - AlreadyUsed
            - NotEligible
          example: "NotEligible  || AlreadyUsed ||  Eligible || NotValid"
          description: it's a enum to have status of check eligiblity  it can be (Eligible ->  user eligible to use this code), (alreadyUsed ->  code used before.) or (notEligible ->  user  not eligible to use this code.), (NotValid -> some inputs failed in validation and reason of validation will be in statusMessageDetails)

        statusMessage:
          type: string
          example: " يمكنك استخدام هذا الكود  ||   تم استخدام الكود من قبل  ||    هذا الكود غير صالح للاستخدام "
          description: it is description for user to be shown in screen if needed
        statusMessageDetails:
          type: string
          example: "user eligible to use this code || user not eligible to use this code || code used before"
          description: it is description for developer descripe the status of Eligibility
        couponOrVoucherKind:
          type: string
          description:  it describes the meaning of the value contained in discountValue it can be one of those values "voucherValue", "discountPercentage", "bonusBuyGroup", "voucherPercentage" or "couponValue"
          example: "voucherValue || discountPercentage || couponValue || bonusBuyGroup || voucherPercentage"
        maxDiscountAmount:
          type: number
          description: highest ammount of money that can be deducted from the transtaction ex. dicount 15% up to 100 pounds
          example: 70
        minimumReceiptAmount:
          type: number
          description: the minimum ammount of money of the receipt for the discount to be eligable
          example: 250
        discountValue:
          type: string
          description: can hold one of those 4 values types accornding to the type mentioned in couponOrVoucherKind
          example: "10 || 0.4 || 0.65 || bonusBuyGroup1 || 0.45"
        loyaltyEligibilityPercent:
          type: number
          example: 0.55 || 0.65 || 0.80
          description: should be a fraction value between 0.0 to 1.0
        eligibilityTransactionId:
          type: string
          example: eligibility0012345
          description: unique identifier for each transaction, should be stored in User-Defined Table (UDT).


    servicesInfo:
      type: object
      properties:
        serviceProvider:
          type: string
          enum:
            - vodafone
            - orange
            - etisalat
            - meeza
        coupons:
          type: array
          description: list of all coupons for this service provider
          items:
            type: object
            properties:
              serviceId:
                type: string
                description: unique identifier for each service
                example: Orange
              displayName:
                type: string
                description: name to be displayed in UI
                example: Orange
              icon:
                type: string
                description: icon path for the service
              attributes:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    minLength:
                      type: number
                    maxLength:
                      type: number
                    shownInUI:
                      type: boolean
                    regexValidation:
                      type: string
                    displayName:
                      type: string
        vouchers:
          type: array
          description: list of all vouchers for this service provider
          items:
            type: object
            properties:
              serviceId:
                type: string
                description: unique identifier for each service
                example: Orange
              displayName:
                type: string
                description: name to be displayed in UI
                example: Orange
              icon:
                type: string
                description: icon path for the service
              attributes:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    minLength:
                      type: number
                    maxLength:
                      type: number
                    shownInUI:
                      type: boolean
                    regexValidation:
                      type: string
                    displayName:
                      type: string
